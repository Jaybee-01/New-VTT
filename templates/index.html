<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice to Text</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="page">
      <header>
        <h1>Whisper<br /><span class="accent">Voiceâ†’Text</span></h1>
        <span class="badge">Powered by faster-whisper</span>
      </header>

      <div id="statusMsg" class="status-msg"></div>

      <div class="grid">
        <!-- Upload Panel -->
        <div class="panel">
          <div class="panel-title">Upload Audio File</div>
          <div
            class="drop-zone"
            id="dropZone"
            onclick="document.getElementById('fileInput').click()"
          >
            <span class="icon">ðŸŽµ</span>
            <span>Drop file here or click to browse</span>
            <small
              style="display: block; margin-top: 0.3rem; font-size: 0.72rem"
              >MP3, WAV, M4A, OGG, FLAC</small
            >
            <input
              type="file"
              id="fileInput"
              accept=".mp3,.wav,.m4a,.ogg,.flac,.webm"
            />
          </div>
          <div id="fileName"></div>
        </div>

        <!-- Record Panel -->
        <div class="panel">
          <div class="panel-title">Record from Microphone</div>
          <div class="record-area">
            <div class="waveform" id="waveform">
              <span></span><span></span><span></span><span></span> <span></span
              ><span></span><span></span>
            </div>
            <button class="rec-btn" id="recBtn" onclick="toggleRecording()">
              <div class="rec-dot"></div>
            </button>
            <div class="rec-timer" id="recTimer">0:00</div>
            <div class="rec-label" id="recLabel">Click to start recording</div>
          </div>
        </div>
      </div>

      <!-- Audio Player â€” appears after recording or uploading -->
      <div class="audio-player" id="audioPlayer">
        <div class="audio-player-header">
          <span class="audio-player-title">ðŸ”Š Playback</span>
          <span class="audio-filename" id="audioFilename"></span>
        </div>
        <audio id="audioEl" controls></audio>
      </div>

      <button
        class="transcribe-btn"
        id="transcribeBtn"
        onclick="transcribe()"
        disabled
      >
        <div class="spinner" id="spinner"></div>
        <span id="btnText">Transcribe Audio</span>
      </button>

      <div class="output-panel">
        <div class="output-header">
          <span>Transcript</span>
          <span class="lang-tag" id="langTag"></span>
        </div>
        <textarea
          id="transcript"
          placeholder="Your transcription will appear here after processing...&#10;&#10;You can also edit the text directly."
        ></textarea>
        <div class="output-footer">
          <span class="char-info" id="charInfo">0 words Â· 0 characters</span>
          <div class="action-btns">
            <button class="btn-sm" onclick="clearAll()">Clear</button>
            <button class="btn-sm" id="copyBtn" onclick="copyText()">
              Copy
            </button>
            <button class="btn-sm" onclick="downloadText()">
              Download .txt
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let audioBlob = null;
      let mediaRecorder = null;
      let isRecording = false;
      let recordingChunks = [];
      let timerInterval = null;
      let seconds = 0;

      const fileInput = document.getElementById("fileInput");
      const dropZone = document.getElementById("dropZone");
      const transcribeBtn = document.getElementById("transcribeBtn");
      const transcript = document.getElementById("transcript");
      const spinner = document.getElementById("spinner");
      const btnText = document.getElementById("btnText");
      const recBtn = document.getElementById("recBtn");
      const recLabel = document.getElementById("recLabel");
      const recTimer = document.getElementById("recTimer");
      const waveform = document.getElementById("waveform");
      const statusMsg = document.getElementById("statusMsg");
      const langTag = document.getElementById("langTag");
      const charInfo = document.getElementById("charInfo");
      const audioPlayer = document.getElementById("audioPlayer");
      const audioEl = document.getElementById("audioEl");
      const audioFilename = document.getElementById("audioFilename");

      // File upload
      fileInput.addEventListener("change", () => {
        if (fileInput.files[0]) selectFile(fileInput.files[0]);
      });

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });
      dropZone.addEventListener("dragleave", () =>
        dropZone.classList.remove("dragover"),
      );
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        if (e.dataTransfer.files[0]) selectFile(e.dataTransfer.files[0]);
      });

      function selectFile(file) {
        audioBlob = file;
        document.getElementById("fileName").textContent = "ðŸ“Ž " + file.name;
        transcribeBtn.disabled = false;
        showAudioPlayer(file, file.name);
        showStatus("File selected: " + file.name, "info");
      }

      function showAudioPlayer(blob, name) {
        const url = URL.createObjectURL(blob);
        audioEl.src = url;
        audioFilename.textContent = name || "recording";
        audioPlayer.classList.add("visible");
      }

      // Recording
      async function toggleRecording() {
        if (isRecording) stopRecording();
        else startRecording();
      }

      async function startRecording() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream);
          recordingChunks = [];

          mediaRecorder.ondataavailable = (e) => recordingChunks.push(e.data);
          mediaRecorder.onstop = () => {
            audioBlob = new Blob(recordingChunks, { type: "audio/webm" });
            showAudioPlayer(audioBlob, "recording.webm");
            transcribeBtn.disabled = false;
            showStatus(
              "Recording saved! Press play to listen, or click Transcribe.",
              "success",
            );
            stream.getTracks().forEach((t) => t.stop());
          };

          mediaRecorder.start();
          isRecording = true;
          seconds = 0;
          recBtn.classList.add("recording");
          recLabel.textContent = "Click to stop recording";
          recTimer.style.display = "block";
          waveform.classList.add("active");

          timerInterval = setInterval(() => {
            seconds++;
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            recTimer.textContent = m + ":" + s.toString().padStart(2, "0");
          }, 1000);
        } catch (e) {
          showStatus(
            "Microphone access denied. Please allow microphone in your browser.",
            "error",
          );
        }
      }

      function stopRecording() {
        if (mediaRecorder) mediaRecorder.stop();
        isRecording = false;
        clearInterval(timerInterval);
        recBtn.classList.remove("recording");
        recLabel.textContent = "Recording saved!";
        waveform.classList.remove("active");
      }

      // Transcribe
      async function transcribe() {
        if (!audioBlob) return;

        transcribeBtn.disabled = true;
        spinner.style.display = "block";
        btnText.textContent = "Transcribing...";
        showStatus("Processing audio with Whisper AI, please wait...", "info");
        langTag.style.display = "none";

        const formData = new FormData();
        formData.append("audio", audioBlob, audioBlob.name || "recording.webm");

        try {
          const res = await fetch("/transcribe", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();

          if (data.error) {
            showStatus("Error: " + data.error, "error");
          } else {
            transcript.value = data.transcript;
            updateWordCount();
            if (data.language) {
              langTag.textContent = "Language: " + data.language.toUpperCase();
              langTag.style.display = "inline";
            }
            showStatus("Transcription complete!", "success");
          }
        } catch (e) {
          showStatus(
            "Connection error. Make sure the Python server is running.",
            "error",
          );
        } finally {
          spinner.style.display = "none";
          btnText.textContent = "Transcribe Audio";
          transcribeBtn.disabled = false;
        }
      }

      function showStatus(msg, type) {
        statusMsg.textContent = msg;
        statusMsg.className = "status-msg " + type;
      }

      function clearAll() {
        transcript.value = "";
        audioBlob = null;
        document.getElementById("fileName").textContent = "";
        fileInput.value = "";
        transcribeBtn.disabled = true;
        langTag.style.display = "none";
        statusMsg.className = "status-msg";
        recLabel.textContent = "Click to start recording";
        recTimer.style.display = "none";
        recTimer.textContent = "0:00";
        audioPlayer.classList.remove("visible");
        audioEl.src = "";
        updateWordCount();
      }

      async function copyText() {
        if (!transcript.value) return;
        await navigator.clipboard.writeText(transcript.value);
        const btn = document.getElementById("copyBtn");
        btn.textContent = "Copied!";
        btn.classList.add("success");
        setTimeout(() => {
          btn.textContent = "Copy";
          btn.classList.remove("success");
        }, 2000);
      }

      function downloadText() {
        if (!transcript.value) return;
        const a = document.createElement("a");
        a.href = URL.createObjectURL(
          new Blob([transcript.value], { type: "text/plain" }),
        );
        a.download = "transcript.txt";
        a.click();
      }

      function updateWordCount() {
        const text = transcript.value.trim();
        const words = text ? text.split(/\s+/).length : 0;
        charInfo.textContent =
          words +
          " word" +
          (words !== 1 ? "s" : "") +
          " Â· " +
          text.length +
          " characters";
      }

      transcript.addEventListener("input", updateWordCount);
    </script>
  </body>
</html>
